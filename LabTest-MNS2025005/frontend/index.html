<!DOCTYPE html>
<html>
<head>
    <title>Diffie-Hellman Client (WASM + Server)</title>
</head>
<body>

<h2>Diffie-Hellman Key Exchange</h2>

<label>Enter p:</label>
<input id="p" type="number"><br><br>

<label>Enter g:</label>
<input id="g" type="number"><br><br>

<button onclick="runDH()">Start Key Exchange</button><br><br>

<textarea id="outputBox" rows="8" cols="50" readonly></textarea>

<script>
    // Ensure process.wasm is loaded from same folder
    var Module = {
        locateFile: function(path) { return path; },
        onRuntimeInitialized: function () {
            // process: BigInt return, BigInt args
            process = Module.cwrap("process", "bigint", ["bigint","bigint","bigint"]);
            console.log("WASM Loaded");
        }
    };

    let process; // the WASM function process(g, a, p)

    async function runDH() {
        // Read and convert to BigInt
        const pVal = document.getElementById("p").value;
        const gVal = document.getElementById("g").value;
        if (!pVal || !gVal) { alert("Enter both p and g"); return; }

        const p = BigInt(pVal);
        const g = BigInt(gVal);

        if (!process) { alert("WASM not loaded yet!"); return; }

        // 1. generate random a âˆˆ Z*_p (1 <= a <= p-2)
        const a = BigInt(Math.floor(Math.random() * Number(p - 2n))) + 1n;

        // 2. compute x = g^a mod p using WASM (myProg.c -> process)
        const x = process(g, a, p); // returns BigInt

        // 3. send <g,p,x> to server as plain strings
        const resp = await fetch("http://localhost:3000/dh", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ g: g.toString(), p: p.toString(), x: x.toString() })
        });

        if (!resp.ok) {
            const txt = await resp.text();
            alert("Server error: " + txt);
            return;
        }

        const data = await resp.json();
        // data.K and data.y are strings (from server)
        const K = data.K;
        const y = data.y;

        // **ONLY** display <K, y, a> as requested
        document.getElementById("outputBox").value =
            "a = " + a.toString() + "\n" +
            " y = " + y + "\n" +
            " Key K = " + K;
    }
</script>

<!-- WASM loader (generated by emcc) -->
<script src="process.js"></script>

</body>
</html>
